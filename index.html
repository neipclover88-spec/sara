<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ì¶œì„ ì²´í¬</title>
<style>
body { font-family: Arial; text-align:center; }
table { border-collapse: collapse; margin:auto; }
td, th { border:1px solid #ccc; padding:6px; }
button { padding:6px 10px; margin:5px; }
.checked { background:#4CAF50; color:white; }
</style>
</head>
<body>

<h2>ì¶œì„ ì²´í¬</h2>
<div id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

<div>
<button onclick="changeMonth(-1)">â—€</button>
<span id="monthLabel"></span>
<button onclick="changeMonth(1)">â–¶</button>
</div>

<br>

<table id="calendar"></table>

<br><br>

<div>
ì´ë¦„:
<input id="nameInput" placeholder="ì´ë¦„ ì…ë ¥">
<button onclick="saveName()">ì €ì¥</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  deleteField,
  onSnapshot,
  collection 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ğŸ”¥ ë„¤ Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyAAbcRjELm-nN_f3XXgcn8eti2PHTMAIYM",
  authDomain: "sara-7bdd3.firebaseapp.com",
  projectId: "sara-7bdd3",
  storageBucket: "sara-7bdd3.firebasestorage.app",
  messagingSenderId: "964270515893",
  appId: "1:964270515893:web:b49b87e1c5c30873ba40fc",
  measurementId: "G-TJ3PQD8PK5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let current = new Date();
let allData = {};
let myName = localStorage.getItem("att_name") || "";

/* Firestore ì‹¤ì‹œê°„ */
const colRef = collection(db, "attendance");

onSnapshot(colRef, (snapshot) => {

  allData = {};

  snapshot.forEach(docSnap => {

    const id = docSnap.id;
    const [y,m,d] = id.split("-").map(Number);

    if(!allData[y]) allData[y] = {};
    if(!allData[y][m]) allData[y][m] = {};
    allData[y][m][d] = docSnap.data();

  });

  render();
  document.getElementById("loading").style.display="none";

});

/* ë Œë” */
function render(){
  const y = current.getFullYear();
  const m = current.getMonth()+1;

  document.getElementById("monthLabel").innerText = `${y}ë…„ ${m}ì›”`;

  const first = new Date(y,m-1,1).getDay();
  const last = new Date(y,m,0).getDate();

  let html="<tr>";
  const days=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  days.forEach(d=> html+=`<th>${d}</th>`);
  html+="</tr><tr>";

  for(let i=0;i<first;i++) html+="<td></td>";

  for(let d=1; d<=last; d++){
    const checked = isChecked(y,m,d,myName);
    html+=`<td class="${checked?'checked':''}" onclick="calClick(${d})">${d}</td>`;
    if((first+d)%7===0) html+="</tr><tr>";
  }

  html+="</tr>";
  document.getElementById("calendar").innerHTML=html;
}

/* ì²´í¬ ì—¬ë¶€ */
function isChecked(y,m,d,name){
  return !!allData[y]?.[m]?.[d]?.[safeKey(name)];
}

/* ë‚ ì§œ í´ë¦­ */
window.calClick = async function(day){

  if(!myName){
    alert("ì´ë¦„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”");
    return;
  }

  const y=current.getFullYear();
  const m=current.getMonth()+1;

  const dateId=`${y}-${m}-${day}`;
  const docRef=doc(db,"attendance",dateId);

  const checked = isChecked(y,m,day,myName);

  if(!checked){
    await setDoc(docRef,{[safeKey(myName)]:true},{merge:true});
  }else{
    await setDoc(docRef,{[safeKey(myName)]:deleteField()},{merge:true});
  }
};

/* ì´ë¦„ ì €ì¥ */
window.saveName = function(){
  const v=document.getElementById("nameInput").value.trim();
  if(!v) return;
  myName=v;
  localStorage.setItem("att_name",v);
  render();
};

/* ì›” ë³€ê²½ */
window.changeMonth = function(diff){
  current.setMonth(current.getMonth()+diff);
  render();
};

function safeKey(name){
  return name.replace(/[/.#$\[\]]/g,"_");
}

</script>
</body>
</html>
