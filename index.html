<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¶œì„ì²´í¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0f1a;
  --surface: #141726;
  --surface2: #1c2035;
  --border: #2a2f4a;
  --accent: #00e5a0;
  --accent2: #4d96ff;
  --accent3: #ffd93d;
  --danger: #ff6b6b;
  --text: #e8eaf0;
  --muted: #5a6080;
}
* { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }
body { font-family:'Noto Sans KR',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* NAV */
.nav {
  position: sticky; top: 0; z-index: 100;
  background: rgba(13,15,26,0.95); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 0.8rem 1.5rem;
  display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;
}
.nav-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
.nav-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }
.nav-month { display: flex; align-items: center; gap: 0.5rem; }
.month-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text); width: 30px; height: 30px; border-radius: 7px; cursor: pointer; font-size: 1rem; transition: all 0.15s; display: flex; align-items: center; justify-content: center; }
.month-btn:hover { border-color: var(--accent); color: var(--accent); }
.month-label { font-family: 'DM Mono', monospace; font-size: 0.88rem; color: var(--accent); min-width: 90px; text-align: center; }
.sync-badge { font-family: 'DM Mono', monospace; font-size: 0.63rem; color: var(--accent); background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.2); padding: 0.2rem 0.6rem; border-radius: 100px; }
.sync-badge.err { color: var(--danger); background: rgba(255,107,107,0.1); border-color: rgba(255,107,107,0.2); }

/* MAIN */
.main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

/* NAME SELECTOR */
.name-selector {
  display: flex; align-items: center; gap: 0.7rem; flex-wrap: wrap;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 0.9rem 1.2rem; margin-bottom: 1.5rem;
}
.name-label { font-size: 0.82rem; color: var(--muted); white-space: nowrap; }
.name-select {
  background: var(--surface2); border: 1px solid var(--border); color: var(--text);
  padding: 0.45rem 1rem; border-radius: 8px;
  font-family: 'Noto Sans KR', sans-serif; font-size: 0.82rem;
  cursor: pointer; outline: none; transition: border-color 0.15s;
}
.name-select:focus { border-color: var(--accent); }
.my-badge {
  font-size: 0.75rem; background: rgba(0,229,160,0.12); color: var(--accent);
  border: 1px solid rgba(0,229,160,0.25); padding: 0.25rem 0.8rem;
  border-radius: 100px; white-space: nowrap;
}
.hint-txt { font-size: 0.75rem; color: var(--muted); }

/* CALENDAR */
.calendar-section { margin-bottom: 2.5rem; }
.section-label { font-family: 'DM Mono', monospace; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); margin-bottom: 0.8rem; }
.weekday-row { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; margin-bottom: 4px; }
.weekday { text-align: center; font-size: 0.68rem; font-family: 'DM Mono', monospace; color: var(--muted); padding: 0.25rem; }
.weekday:first-child { color: #ff6b6b88; }
.weekday:last-child { color: #4d96ff88; }
.calendar-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }

.cal-cell {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 0.6rem 0.4rem; min-height: 70px;
  cursor: pointer; transition: all 0.18s;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.cal-cell:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,229,160,0.1); }
.cal-cell.today { border-color: var(--accent); }
  .cal-cell.holiday { border-color: rgba(255,107,107,0.3); }
.cal-cell.holiday .cal-day { color: #ff6b6b; }
.cal-holiday { font-size: 0.55rem; color: #ff6b6b; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cal-cell.today .cal-day { color: var(--accent); }
.cal-cell.empty { background: transparent; border-color: transparent; cursor: default; pointer-events: none; }
.cal-cell.my-checked { background: rgba(0,229,160,0.06); border-color: rgba(0,229,160,0.4); }
.cal-day { font-size: 0.92rem; font-weight: 700; line-height: 1; }
.cal-cell.sun .cal-day { color: #ff6b6b; }
.cal-cell.sat .cal-day { color: var(--accent2); }
.cal-count { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--accent); background: rgba(0,229,160,0.1); padding: 0.1rem 0.4rem; border-radius: 100px; }
.cal-count.zero { color: var(--muted); background: transparent; }
  .member-total { 
  font-family: 'DM Mono', monospace; font-size: 0.7rem;
  color: var(--accent3); background: rgba(255,217,61,0.1);
  border: 1px solid rgba(255,217,61,0.2);
  padding: 0.1rem 0.45rem; border-radius: 100px;
  white-space: nowrap;
}
.member-total.zero { color: var(--muted); background: transparent; border-color: transparent; }
.cal-dots { display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; max-width: 36px; }
.cal-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); opacity: 0.5; }

/* DIVIDER */
hr.divider { border: none; border-top: 1px solid var(--border); margin: 0.5rem 0 1.5rem; }

/* ATTENDANCE TABLE */
.att-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
.att-title { font-size: 1.1rem; font-weight: 700; }
.selected-badge {
  font-family: 'DM Mono', monospace; font-size: 0.72rem;
  color: var(--accent3); background: rgba(255,217,61,0.1);
  border: 1px solid rgba(255,217,61,0.2); padding: 0.28rem 0.8rem; border-radius: 100px;
}

.table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; }
thead tr th {
  background: var(--surface2);
  padding: 0.65rem 0.4rem;
  font-size: 0.68rem; font-family: 'DM Mono', monospace;
  color: var(--muted); border-bottom: 2px solid var(--border);
  white-space: nowrap; text-align: center;
}
thead tr th.name-col { text-align: left; padding-left: 1rem; min-width: 140px; color: var(--text); font-size: 0.75rem; }
thead tr th.day-col { min-width: 32px; cursor: pointer; transition: color 0.15s; }
thead tr th.day-col:hover { color: var(--accent); }
thead tr th.today-col { color: var(--accent) !important; }
thead tr th.sun-col { color: #ff6b6b66; }
thead tr th.sat-col { color: #4d96ff66; }

tbody tr { border-bottom: 1px solid rgba(42,47,74,0.6); transition: background 0.12s; }
tbody tr:last-child { border-bottom: none; }
tbody tr.my-row { background: rgba(0,229,160,0.03); }
tbody tr:hover { background: rgba(255,255,255,0.02); }
tbody tr.stats-row { background: var(--surface2) !important; border-top: 2px solid var(--border); }

td { padding: 0.5rem 0.4rem; text-align: center; }
td.name-cell { text-align: left; padding-left: 1rem; font-size: 0.82rem; font-weight: 500; white-space: nowrap; }
td.name-cell.my-name { color: var(--accent); font-weight: 700; }
td.stat-cell { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--muted); }
td.stat-cell.has-cnt { color: var(--accent); font-weight: 500; }

/* CHECKBOX */
.check-box {
  width: 18px; height: 18px; border-radius: 4px;
  border: 1.5px solid var(--border); background: transparent;
  cursor: pointer; appearance: none; -webkit-appearance: none;
  transition: all 0.13s; position: relative; display: block; margin: 0 auto;
}
.check-box:checked { background: var(--accent); border-color: var(--accent); }
.check-box:checked::after {
  content: ''; position: absolute;
  top: 2px; left: 4px; width: 6px; height: 9px;
  border: 2px solid #0d0f1a; border-top: none; border-left: none;
  transform: rotate(45deg);
}
.check-box:disabled { opacity: 0.15; cursor: not-allowed; }
.check-box:hover:not(:checked):not(:disabled) { border-color: var(--accent); background: rgba(0,229,160,0.08); }

/* LOADING */
.loading { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; transition: opacity 0.4s; }
.loading.hidden { opacity: 0; pointer-events: none; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
.loading-txt { font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); }
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 600px) {
  .main { padding: 1rem; }
  .cal-cell { min-height: 56px; }
  .cal-day { font-size: 0.8rem; }
}
</style>
</head>
<body>

<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-txt">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<nav class="nav">
  <div class="nav-title"><span class="nav-dot"></span>ì¶œì„ì²´í¬</div>
  <div class="nav-month">
    <button class="month-btn" onclick="changeMonth(-1)">â€¹</button>
    <span class="month-label" id="monthLabel"></span>
    <button class="month-btn" onclick="changeMonth(1)">â€º</button>
  </div>
  <span class="sync-badge" id="syncBadge">ì—°ê²° ì¤‘...</span>
</nav>

<div class="main">

  <!-- ì´ë¦„ ì„ íƒ -->
  <div class="name-selector">
    <span class="name-label">ë‚´ ì´ë¦„ ì„ íƒ:</span>
    <select class="name-select" id="nameSelect" onchange="onNameChange()">
      <option value="">-- ì„ íƒ --</option>
    </select>
    <span class="my-badge" id="myBadge" style="display:none"></span>
    <span class="hint-txt" id="hintTxt">ì´ë¦„ì„ ì„ íƒí•˜ë©´ ë‹¬ë ¥ í´ë¦­ìœ¼ë¡œ ë°”ë¡œ ì²´í¬í•  ìˆ˜ ìˆì–´ìš”</span>
  </div>

  <!-- ë‹¬ë ¥ -->
  <div class="calendar-section">
    <div class="section-label" id="calLabel"></div>
    <div class="weekday-row">
      <div class="weekday">ì¼</div><div class="weekday">ì›”</div><div class="weekday">í™”</div>
      <div class="weekday">ìˆ˜</div><div class="weekday">ëª©</div><div class="weekday">ê¸ˆ</div><div class="weekday">í† </div>
    </div>
    <div class="calendar-grid" id="calGrid"></div>
  </div>

  <hr class="divider" id="divider">

  <!-- ì¶œì„ í…Œì´ë¸” -->
  <div id="attSection">
    <div class="att-header">
      <div class="att-title">ì „ì²´ ì¶œì„ ê´€ë¦¬</div>
      <span class="selected-badge" id="selectedBadge" style="display:none"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  deleteField,
  onSnapshot,
  collection 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ğŸ”¥ ë„¤ Firestore í”„ë¡œì íŠ¸ */
const firebaseConfig = {
  apiKey: "AIzaSyAAbcRjELm-nN_f3XXgcn8eti2PHTMAIYM",
  authDomain: "sara-7bdd3.firebaseapp.com",
  projectId: "sara-7bdd3",
  storageBucket: "sara-7bdd3.firebasestorage.app",
  messagingSenderId: "964270515893",
  appId: "1:964270515893:web:b49b87e1c5c30873ba40fc",
  measurementId: "G-TJ3PQD8PK5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let allData = {};
let myName = localStorage.getItem('att_myname') || '';

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const colRef = collection(db, "attendance");

onSnapshot(colRef, (snapshot) => {

  allData = {};

  snapshot.forEach(docSnap => {

    const id = docSnap.id; // ì˜ˆ: 2026-1-27
    const [y, m, d] = id.split('-').map(Number);

    if (!allData[y]) allData[y] = {};
    if (!allData[y][m]) allData[y][m] = {};

    allData[y][m][d] = docSnap.data();

  });

  render();
  document.getElementById('loading').classList.add('hidden');
  setSyncStatus(true);

}, () => {
  document.getElementById('loading').classList.add('hidden');
  setSyncStatus(false);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì²´í¬ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveCheck(y, m, d, member, checked) {

  const dateId = `${y}-${m}-${d}`;
  const docRef = doc(db, "attendance", dateId);

  if (checked) {

    await setDoc(docRef, {
      [mKey(member)]: true
    }, { merge: true });

  } else {

    await setDoc(docRef, {
      [mKey(member)]: deleteField()
    }, { merge: true });

  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function mKey(name) {
  return name.replace(/[/.#$\[\]]/g, '_');
}

function isChecked(y, m, d, member) {
  return !!(allData[y]?.[m]?.[d]?.[mKey(member)]);
}

function dayCount(y, m, d) {
  const obj = allData[y]?.[m]?.[d] || {};
  return Object.values(obj).filter(Boolean).length;
}

/* ğŸ”¥ ê¸°ì¡´ ë Œë”/ì´ë²¤íŠ¸ ì½”ë“œë“¤ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©ë¨ */
/* render(), renderCalendar(), renderTable(), 
   changeMonth(), handleTableCheck(), 
   calCellClick() ë“±ì€ ìˆ˜ì • í•„ìš” ì—†ìŒ */

</script>
</body>
</html>
